<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Stairway to Service Mesh</title>
        <link rel="stylesheet" href="./css/reveal.css">
        <link rel="stylesheet" href="./theme/custom.css" id="theme">
        <link rel="stylesheet" href="./css/highlight/solarized-light.css">
        <link rel="stylesheet" href="./css/print/paper.css" type="text/css" media="print">

    </head>
    <body>

        <div class="reveal">
            <div class="slides"><section  data-markdown><script type="text/template">

# Stairway to <br> Service Mesh

Stefan Siegl (@stesie23, <rolf@mayflower.de>)

</script></section><section  data-markdown><script type="text/template">

# Agenda

* (brief) Kubernetes Recap
* Why Service Mesh? Why Istio?
* Traffic control
* How does it work?
* Moar goodness

</script></section><section ><section data-markdown><script type="text/template">

# Kubernetes Recap

</script></section><section data-markdown><script type="text/template">

![Kubernetes Basic Structure](images/01-kube-basics.png)

</script></section><section data-markdown><script type="text/template">

![Multiple Pods in Deployment, Service pointing towards them](images/02-multiple-pods.png)

</script></section><section data-markdown><script type="text/template">

![Pods may consist of multiple containers, including init containers](images/03-multi-container-pod.png)

</script></section></section><section ><section data-markdown><script type="text/template">

# Why Service Mesh?

</script></section><section data-markdown><script type="text/template">

so we've got an increasing number of microservices ...

</script></section><section data-markdown><script type="text/template">

all integrating over http ...

</script></section><section data-markdown><script type="text/template">

* which one is talking to which one?
* how many requests (and errors) are there?
* how to deploy a canary release?
* how to avoid cascading effects in overload situations?
* how to instrument external services?

</script></section><section data-markdown><script type="text/template">

# Why Istio?

* AWS & Azure both provide proprietary solutions  
  â‡¨ vendor lock-in
* Istio supported by Google
* ... and provided on GKE since recently

</script></section></section><section ><section data-markdown><script type="text/template">

# Traffic Control

* canary release: split traffic 95% - 5%
* or route traffic based on user agent
* or actually just any HTTP header

</script></section><section data-markdown><script type="text/template">

![One Service, backed by two different deployed versions](images/multiple-deployments.png)

**Problem**: cannot control traffic between v1 & v2  :-(

</script></section><section data-markdown><script type="text/template">

```yaml
kind: Deployment
metadata:
  name: somesvc-v1
spec:
  selector:
    matchLabels:
      app: somesvc
      version: v1
  template:
    ...
    spec:
      containers:
      - name: somesvc
        ...
        env:
        - name: EXTRA_MESSAGE
          value: das hier ist Version 1 :-)
```

</script></section><section data-markdown><script type="text/template">

```yaml
kind: Deployment
metadata:
  name: somesvc-v2
spec:
  selector:
    matchLabels:
      app: somesvc
      version: v2
  template:
    ...
    spec:
      containers:
      - name: somesvc
        ...
        env:
        - name: EXTRA_MESSAGE
          value: und das hier ist v2!
```

</script></section><section data-markdown><script type="text/template">

```yaml
kind: Service
metadata:
  name: somesvc
  labels:
    app: somesvc
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 3000
    name: http
  selector:
    app: somesvc
```

</script></section><section data-markdown><script type="text/template">

DEMO: curl to Service's NodePort

</script></section><section data-markdown><script type="text/template">

## Istio to the rescue!

* create subsets with `DestinationRule`
* route to subsets via `VirtualService`

</script></section><section data-markdown><script type="text/template">

![Traffic-flow within Istio-enabled Mesh](images/istio-traffic-routing.png)

</script></section><section data-markdown><script type="text/template">

```yaml
apiVersion: "networking.istio.io/v1alpha3"
kind: "DestinationRule"
metadata:
  name: somesvc
spec:
  host: somesvc
  subsets:
    - name: v1
      labels:
        version: v1
    - name: v2
      labels:
        version: v2
```

</script></section><section data-markdown><script type="text/template">

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: somesvc
spec:
  ...
    route:
    - destination:
        host: somesvc
        subset: v1
      weight: 95
    - destination:
        host: somesvc
        subset: v2
      weight: 5
```

</script></section><section data-markdown><script type="text/template">

DEMO: curl to ingressgateway

</script></section><section data-markdown><script type="text/template">

## so how does it work?

</script></section><section data-markdown><script type="text/template">

```
$ kubectl get pods
NAME                          READY     STATUS    RESTARTS   AGE
somesvc-v1-74666f9dd9-bgj9j   2/2       Running   0          2h
```

</script></section><section data-markdown><script type="text/template">

## what is this secondary container?

... and where does it come from?

</script></section><section data-markdown><script type="text/template">

![Sidecar-Proxy/Envoy within Pod](images/proxy-sidecar.png)

</script></section><section data-markdown><script type="text/template">

manual mode:

```
$ istioctl kube-inject -f deployment.yml | kubectl apply -f -
```

automatic:

```
$ kubectl label namespace default istio-injection=enabled
```

</script></section></section><section ><section data-markdown><script type="text/template">

# External Services

* ever faced an outage due to an external service?
* limit the maximum request time?
* limit maximum number of concurrent requests?
* what happens if latencies increase, or http errors occur?

</script></section><section data-markdown><script type="text/template">

## HTTP traffic

* instrumentation like with internal traffic
* `ServiceEntry`: declare external service
* `VirtualService`: request timeouts & fault injection
* `DestinationRule`: configure connection pool

</script></section><section data-markdown><script type="text/template">

## HTTPS traffic

* `VirtualService` can match based on TLS SNI
* timeouts can be configured
* yet fault injection doesn't work (due to encryption)

</script></section><section data-markdown><script type="text/template">

## Solution (work-around)

* let app speak "http" on port 443 (sic!)
* set `tls.mode = SIMPLE` on `DestinationRule`
* envoy will handle encryption and sees unencrypted traffic now
* ... hence able to inject faults

</script></section><section data-markdown><script type="text/template">

also applies to runtime (debugging) package installs

```
$ docker run -ti  --privileged --net=container:k8s_POD_somesvc-v2-599679685-w48kn_default_0f32e005-f78e-11e8-a17c-080027684af6_0 alpine
/ # apk add iptables
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
ERROR: http://dl-cdn.alpinelinux.org/alpine/v3.8/main: No such file or directory
WARNING: Ignoring APKINDEX.adfa7ceb.tar.gz: No such file or directory
...
```

</script></section><section data-markdown><script type="text/template">

External services need to be whitelisted

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: alpine
spec:
  hosts:
  - dl-cdn.alpinelinux.org
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: NONE
  location: MESH_EXTERNAL
```

</script></section></section><section ><section data-markdown><script type="text/template">

## Traffic visualisation

</script></section><section data-markdown><script type="text/template">

* simplest approach: servicegraph
* servicegraph must be enabled
* not exposed by default, must port-forward

</script></section><section data-markdown><script type="text/template">

![Rendered servicegraph plot](images/istio-servicegraph.png)

</script></section><section data-markdown><script type="text/template">

```
$ kubectl port-forward -n istio-system service/servicegraph 8088
```

http://localhost:8088/force/forcegraph.html

</script></section><section data-markdown><script type="text/template">

## Alternatives

* Kiali - interactive, just-in-time traffic monitor
* Jaeger - open-tracing compatible tracing
  * envoy proxies automatically collect tracing data

</script></section></section><section ><section data-markdown><script type="text/template">

# moar goodness

</script></section><section data-markdown><script type="text/template">

## mutual TLS

* most microservices use plain http traffic
* neither encrypted nor authenticated
* Istio provides *mutual TLS*
  * citadel creates key/certificate pairs
  * provided to pods istio-proxy pods via secrets
  * envoy verifies certificates & encrypts traffic

</script></section><section data-markdown><script type="text/template">

## more integrations

* Prometheus
* Grafana



</script></section></section><section  data-markdown><script type="text/template">

# That's it!

## Questions?

Stefan Siegl (@stesie23, <rolf@mayflower.de>)

</script></section><section  data-markdown><script type="text/template">

# Workshop

```
$ git clone https://git.mayflower.de/stefan.siegl/istio-workshop.git
$ cd istio-workshop; view README.md

```
</script></section></div>
        </div>

        <script src="./lib/js/head.min.js"></script>
        <script src="./js/reveal.js"></script>

        <script>
            function extend() {
              var target = {};
              for (var i = 0; i < arguments.length; i++) {
                var source = arguments[i];
                for (var key in source) {
                  if (source.hasOwnProperty(key)) {
                    target[key] = source[key];
                  }
                }
              }
              return target;
            }

            // Optional libraries used to extend on reveal.js
            var deps = [
              { src: './lib/js/classList.js', condition: function() { return !document.body.classList; } },
              { src: './plugin/markdown/marked.js', condition: function() { return !!document.querySelector('[data-markdown]'); } },
              { src: './plugin/markdown/markdown.js', condition: function() { return !!document.querySelector('[data-markdown]'); } },
              { src: './plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
              { src: './plugin/zoom-js/zoom.js', async: true },
              { src: './plugin/notes/notes.js', async: true },
              { src: './plugin/math/math.js', async: true }
            ];

            // default options to init reveal.js
            var defaultOptions = {
              controls: true,
              progress: true,
              history: true,
              center: true,
              transition: 'default', // none/fade/slide/convex/concave/zoom
              dependencies: deps
            };

            // options from URL query string
            var queryOptions = Reveal.getQueryHash() || {};

            var options = {};
            options = extend(defaultOptions, options, queryOptions);
            Reveal.initialize(options);
        </script>
        
    </body>
</html>
